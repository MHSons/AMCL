<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Registration Slip</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="style.css">
  <style>
    .slip { max-width:700px; margin:20px auto; border:1px solid #ddd; padding:18px; background:white; }
    .slip h2{ margin-top:0 }
    .print-btn{ margin-bottom:10px; }
    pre { background:#fafafa; padding:10px; border-radius:6px; }
  </style>
</head>
<body>
  <div class="container">
    <div id="slipArea"></div>
    <div style="text-align:center; margin-top:10px">
      <button onclick="window.print()" class="btn">Print</button>
      <a href="view_reports.html" class="btn alt">Back</a>
    </div>
  </div>

  <script src="tests.js"></script>
  <script>
    function getParam(name) {
      const params = new URLSearchParams(window.location.search);
      return params.get(name);
    }
    const id = getParam('id');
    const view = getParam('view'); // optional to show results
    const patients = JSON.parse(localStorage.getItem('patients')||'[]');
    const p = patients.find(x => x.id === id);
    const area = document.getElementById('slipArea');
    if (!p) { area.innerHTML = '<div class="small">Patient not found</div>'; throw new Error('not found'); }

    let html = `<div class="slip"><h2>Registration Slip</h2><strong>${p.name}</strong> (${p.id})<div class="small">Age: ${p.age} | Gender: ${p.gender} | Phone: ${p.phone}</div><hr>`;
    html += `<div><strong>Department:</strong> ${p.department}</div><div class="small">Tests requested: ${p.tests.length}</div>`;
    if (p.tests && p.tests.length) {
      html += '<ol>';
      p.tests.forEach(tid => {
        let meta = null;
        departments.forEach(d => { if(!meta) meta = d.tests.find(tt => tt.id === tid) });
        html += `<li>${meta ? meta.name : tid} <span class="small">(${meta ? meta.unit : ''})</span></li>`;
      });
      html += '</ol>';
    }
    if (view === 'results') {
      const results = JSON.parse(localStorage.getItem('results')||'[]').filter(r=>r.patientId===p.id);
      if (results.length) {
        html += '<hr><h3>Results</h3>';
        results.forEach(r => {
          html += `<div class="small">Entered: ${new Date(r.created).toLocaleString()} by ${r.enteredBy}</div><pre>${JSON.stringify(r.results, null, 2)}</pre>`;
        });
      } else {
        html += '<div class="small">No results found for this patient.</div>';
      }
    }
    html += '</div>';
    area.innerHTML = html;
  </script>
</body>
</html>
