<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Add Result | AlphaMed Clinical Laboratory</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg,#1e3a8a,#2563eb);
      margin: 0; color:#111;
    }
    .container {
      max-width: 900px;
      margin: 40px auto;
      background: #fff;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.2);
    }
    h2 { text-align:center; color:#1e3a8a; }
    select, input, button {
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
      margin: 5px 0;
      font-size: 14px;
    }
    table { width:100%; border-collapse: collapse; margin-top:15px; }
    th,td { padding:6px; border-bottom:1px solid #eee; }
    th { background:#f3f4f6; color:#1e3a8a; }
    .btn { background:#2563eb; color:white; border:none; cursor:pointer; }
    .btn:hover { background:#1e3a8a; }
  </style>
</head>
<body>

<div class="container">
  <h2>Add Test Results</h2>

  <label>Patient Code:</label>
  <input id="patientCode" placeholder="Enter patient code"><br>

  <label>Select Department(s):</label><br>
  <select id="departmentSelect" multiple size="6" style="width:100%;"></select><br>

  <label>Select Test:</label><br>
  <select id="testSelect" style="width:100%;"></select><br>

  <label>Result:</label><br>
  <input id="resultValue" placeholder="Enter result"><br>
  <button class="btn" onclick="addResult()">Add to Report</button>

  <table>
    <thead><tr>
      <th>Department</th><th>Test</th><th>Result</th><th>Unit</th><th>Normal Range</th><th>Indicator</th>
    </tr></thead>
    <tbody id="resultsTable"></tbody>
  </table>

  <div style="text-align:center;margin-top:15px;">
    <button class="btn" onclick="saveReport()">Save & View Report</button>
  </div>
</div>

<script>
  // --- 1. Sample real department data ---
  const departments = {
    "Hematology":[
      {test:"Hemoglobin",unit:"g/dL",min:13,max:17},
      {test:"RBC Count",unit:"million/uL",min:4.5,max:6.0},
      {test:"WBC Count",unit:"/uL",min:4000,max:11000},
      {test:"Platelet Count",unit:"/uL",min:150000,max:450000}
    ],
    "Biochemistry":[
      {test:"Glucose (Fasting)",unit:"mg/dL",min:70,max:100},
      {test:"Urea",unit:"mg/dL",min:10,max:50},
      {test:"Creatinine",unit:"mg/dL",min:0.7,max:1.3},
      {test:"Cholesterol",unit:"mg/dL",min:0,max:200}
    ],
    "Serology":[
      {test:"HIV",unit:"",min:0,max:0},
      {test:"Hepatitis B Surface Antigen",unit:"",min:0,max:0},
      {test:"Hepatitis C Antibody",unit:"",min:0,max:0},
      {test:"VDRL",unit:"",min:0,max:0}
    ],
    "Microbiology":[
      {test:"Urine Culture",unit:"",min:0,max:0},
      {test:"Sputum Culture",unit:"",min:0,max:0},
      {test:"Blood Culture",unit:"",min:0,max:0}
    ]
  };

  // populate department list
  const deptSel=document.getElementById('departmentSelect');
  Object.keys(departments).forEach(d=>{
    const opt=document.createElement('option');
    opt.value=d; opt.textContent=d;
    deptSel.appendChild(opt);
  });

  // when dept changes => show related tests
  deptSel.addEventListener('change',()=>{
    const testSel=document.getElementById('testSelect');
    testSel.innerHTML='';
    const selected=Array.from(deptSel.selectedOptions).map(o=>o.value);
    selected.forEach(dep=>{
      departments[dep].forEach(t=>{
        const opt=document.createElement('option');
        opt.value=dep+'|'+t.test;
        opt.textContent=`${dep} - ${t.test}`;
        testSel.appendChild(opt);
      });
    });
  });

  // --- 2. Add result row ---
  const results=[];
  function addResult(){
    const testVal=document.getElementById('testSelect').value;
    if(!testVal){alert('Select a test');return;}
    const [dep,testName]=testVal.split('|');
    const data=departments[dep].find(t=>t.test===testName);
    const result=parseFloat(document.getElementById('resultValue').value);
    if(isNaN(result)){alert('Enter numeric result');return;}
    let indicator='Normal';
    if(result<data.min)indicator='Low';
    else if(result>data.max)indicator='High';
    results.push({department:dep,test:testName,result,unit:data.unit,range:`${data.min}-${data.max}`,indicator});
    renderTable();
    document.getElementById('resultValue').value='';
  }

  function renderTable(){
    const tb=document.getElementById('resultsTable');
    tb.innerHTML='';
    results.forEach(r=>{
      const tr=document.createElement('tr');
      const color=(r.indicator==='Normal')?'green':'red';
      tr.innerHTML=`<td>${r.department}</td><td>${r.test}</td>
        <td>${r.result}</td><td>${r.unit}</td><td>${r.range}</td>
        <td style="color:${color};font-weight:600">${r.indicator}</td>`;
      tb.appendChild(tr);
    });
  }

  // --- 3. Save report ---
  function saveReport(){
    if(results.length===0){alert('Add at least one test');return;}
    const patient_code=document.getElementById('patientCode').value.trim();
    if(!patient_code){alert('Enter patient code');return;}
    const report_id='R'+Date.now();
    const newReport={
      report_id,
      patient_name:patient_code,
      patient_code,
      department:results.map(r=>r.department).join(', '),
      results,
      date:new Date().toISOString()
    };
    const reports=JSON.parse(localStorage.getItem('reports')||'[]');
    reports.push(newReport);
    localStorage.setItem('reports',JSON.stringify(reports));
    localStorage.setItem('lastReportId',report_id);
    alert('Report saved!');
    window.location='report.html';
  }
</script>
<script src="app.js"></script>
</body>
</html>
