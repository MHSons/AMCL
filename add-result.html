<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Add Result | AlphaMed Clinical Laboratory</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg,#1e3a8a,#2563eb);
      margin: 0; color:#111;
    }
    .container {
      max-width: 900px;
      margin: 40px auto;
      background: #fff;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.2);
    }
    h2 { text-align:center; color:#1e3a8a; }
    select, input, button {
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
      margin: 5px 0;
      font-size: 14px;
    }
    table { width:100%; border-collapse: collapse; margin-top:15px; }
    th,td { padding:6px; border-bottom:1px solid #eee; }
    th { background:#f3f4f6; color:#1e3a8a; }
    .btn { background:#2563eb; color:white; border:none; cursor:pointer; }
    .btn:hover { background:#1e3a8a; }
  </style>
</head>
<body>

<div class="container">
  <h2>Add Test Results</h2>

  <label>Patient Code:</label>
  <input id="patientCode" placeholder="Enter patient code"><br>

  <label>Select Department(s):</label><br>
  <select id="departmentSelect" multiple size="6" style="width:100%;"></select><br>

  <label>Select Test:</label><br>
  <select id="testSelect" style="width:100%;"></select><br>

  <label>Result:</label><br>
  <input id="resultValue" placeholder="Enter result"><br>
  <button class="btn" onclick="addResult()">Add to Report</button>

  <table>
    <thead><tr>
      <th>Department</th><th>Test</th><th>Result</th><th>Unit</th><th>Normal Range</th><th>Indicator</th>
    </tr></thead>
    <tbody id="resultsTable"></tbody>
  </table>

  <div style="text-align:center;margin-top:15px;">
    <button class="btn" onclick="saveReport()">Save & View Report</button>
  </div>
</div>

<script>
  // ===== ACCESS CONTROL =====
  const logged = JSON.parse(localStorage.getItem('loggedUser') || 'null');
  if (!logged) {
    alert('Please login first!');
    window.location.href = 'index.html';
  } 
  else if (!['admin','technician'].includes(logged.role)) {
    alert('You are not authorized to add or modify reports.');
    window.location.href = 'dashboard.html';
  }

  // ===== REAL DEPARTMENT DATA (Part-1) =====
  const departments = {
    "Hematology": [
      { test: "Hemoglobin (Hb)", unit: "g/dL", min: 13, max: 17 },
      { test: "Hematocrit (HCT)", unit: "%", min: 40, max: 52 },
      { test: "RBC Count", unit: "million/uL", min: 4.5, max: 6.0 },
      { test: "WBC Count", unit: "/uL", min: 4000, max: 11000 },
      { test: "Platelet Count", unit: "/uL", min: 150000, max: 450000 }
    ],
    "Biochemistry": [
      { test: "Glucose (Fasting)", unit: "mg/dL", min: 70, max: 100 },
      { test: "Urea", unit: "mg/dL", min: 10, max: 50 },
      { test: "Creatinine", unit: "mg/dL", min: 0.7, max: 1.3 }
    ],
    "Serology": [
      { test: "Hepatitis B Surface Antigen (HBsAg)", unit: "", min: 0, max: 0 },
      { test: "Hepatitis C Antibody (Anti-HCV)", unit: "", min: 0, max: 0 },
      { test: "HIV 1/2 Antibody", unit: "", min: 0, max: 0 }
    ],
      "Microbiology": [
    { test: "Urine Culture", unit: "", min: 0, max: 0 },
    { test: "Sputum Culture", unit: "", min: 0, max: 0 },
    { test: "Blood Culture", unit: "", min: 0, max: 0 },
    { test: "Throat Swab Culture", unit: "", min: 0, max: 0 },
    { test: "Stool Culture", unit: "", min: 0, max: 0 },
    { test: "Wound Swab Culture", unit: "", min: 0, max: 0 },
    { test: "Ear Swab Culture", unit: "", min: 0, max: 0 },
    { test: "Pus Culture", unit: "", min: 0, max: 0 }
  ],
  "Clinical Pathology": [
    { test: "Urine Routine Examination", unit: "", min: 0, max: 0 },
    { test: "Stool Routine Examination", unit: "", min: 0, max: 0 },
    { test: "CSF Analysis", unit: "", min: 0, max: 0 },
    { test: "Semen Analysis", unit: "", min: 0, max: 0 },
    { test: "Pleural Fluid Analysis", unit: "", min: 0, max: 0 },
    { test: "Ascitic Fluid Analysis", unit: "", min: 0, max: 0 },
    { test: "Synovial Fluid Analysis", unit: "", min: 0, max: 0 },
    { test: "Pericardial Fluid Analysis", unit: "", min: 0, max: 0 }
  ],
  "Urine Analysis": [
    { test: "Color", unit: "", min: 0, max: 0 },
    { test: "Appearance", unit: "", min: 0, max: 0 },
    { test: "Specific Gravity", unit: "", min: 1.005, max: 1.030 },
    { test: "pH", unit: "", min: 4.5, max: 8.0 },
    { test: "Protein", unit: "", min: 0, max: 0 },
    { test: "Glucose", unit: "", min: 0, max: 0 },
    { test: "Ketone", unit: "", min: 0, max: 0 },
    { test: "Bilirubin", unit: "", min: 0, max: 0 },
    { test: "Urobilinogen", unit: "", min: 0, max: 0 },
    { test: "Nitrite", unit: "", min: 0, max: 0 }
  ],
  "Liver Function": [
    { test: "Total Bilirubin", unit: "mg/dL", min: 0.2, max: 1.2 },
    { test: "Direct Bilirubin", unit: "mg/dL", min: 0.0, max: 0.3 },
    { test: "Indirect Bilirubin", unit: "mg/dL", min: 0.1, max: 0.9 },
    { test: "ALT (SGPT)", unit: "U/L", min: 0, max: 45 },
    { test: "AST (SGOT)", unit: "U/L", min: 0, max: 40 },
    { test: "Alkaline Phosphatase", unit: "U/L", min: 44, max: 147 },
    { test: "Total Protein", unit: "g/dL", min: 6.0, max: 8.3 },
    { test: "Albumin", unit: "g/dL", min: 3.5, max: 5.0 },
    { test: "Globulin", unit: "g/dL", min: 2.0, max: 3.5 },
    { test: "A/G Ratio", unit: "", min: 1.0, max: 2.0 }
  ],
  "Thyroid Function": [
    { test: "TSH", unit: "uIU/mL", min: 0.4, max: 4.0 },
    { test: "T3 (Triiodothyronine)", unit: "ng/dL", min: 80, max: 200 },
    { test: "T4 (Thyroxine)", unit: "ug/dL", min: 4.5, max: 12.0 },
    { test: "Free T3", unit: "pg/mL", min: 2.0, max: 4.4 },
    { test: "Free T4", unit: "ng/dL", min: 0.9, max: 2.3 }
  ],
  "Lipid Profile": [
    { test: "Cholesterol (Total)", unit: "mg/dL", min: 0, max: 200 },
    { test: "HDL Cholesterol", unit: "mg/dL", min: 40, max: 60 },
    { test: "LDL Cholesterol", unit: "mg/dL", min: 0, max: 130 },
    { test: "Triglycerides", unit: "mg/dL", min: 0, max: 150 },
    { test: "VLDL", unit: "mg/dL", min: 5, max: 30 }
  ],
      "Tumor Markers": [
    { test: "Alpha-Fetoprotein (AFP)", unit: "ng/mL", min: 0, max: 10 },
    { test: "Carcinoembryonic Antigen (CEA)", unit: "ng/mL", min: 0, max: 5 },
    { test: "CA-125", unit: "U/mL", min: 0, max: 35 },
    { test: "CA-19-9", unit: "U/mL", min: 0, max: 37 },
    { test: "Prostate Specific Antigen (PSA)", unit: "ng/mL", min: 0, max: 4 },
    { test: "Beta-hCG", unit: "mIU/mL", min: 0, max: 5 }
  ],
  "Coagulation Profile": [
    { test: "Prothrombin Time (PT)", unit: "sec", min: 11, max: 15 },
    { test: "INR", unit: "", min: 0.8, max: 1.2 },
    { test: "Activated Partial Thromboplastin Time (aPTT)", unit: "sec", min: 25, max: 35 },
    { test: "Bleeding Time", unit: "min", min: 2, max: 9 },
    { test: "Clotting Time", unit: "min", min: 5, max: 15 },
    { test: "Fibrinogen", unit: "mg/dL", min: 200, max: 400 }
  ],
  "Cardiac Enzymes": [
    { test: "Troponin-I", unit: "ng/mL", min: 0, max: 0.04 },
    { test: "CK-MB", unit: "ng/mL", min: 0, max: 5 },
    { test: "LDH", unit: "U/L", min: 140, max: 280 },
    { test: "Myoglobin", unit: "ng/mL", min: 0, max: 85 }
  ],
  "Infectious Diseases": [
    { test: "Malaria Parasite (MP Smear)", unit: "", min: 0, max: 0 },
    { test: "Dengue NS1 Antigen", unit: "", min: 0, max: 0 },
    { test: "Dengue IgM", unit: "", min: 0, max: 0 },
    { test: "Dengue IgG", unit: "", min: 0, max: 0 },
    { test: "Typhoid (Widal)", unit: "", min: 0, max: 0 },
    { test: "COVID-19 PCR", unit: "", min: 0, max: 0 }
  ],
  "Hormone Assay": [
    { test: "FSH", unit: "mIU/mL", min: 1.5, max: 12.4 },
    { test: "LH", unit: "mIU/mL", min: 1.7, max: 8.6 },
    { test: "Prolactin", unit: "ng/mL", min: 4.0, max: 23.0 },
    { test: "Testosterone", unit: "ng/dL", min: 300, max: 1000 },
    { test: "Estrogen (E2)", unit: "pg/mL", min: 25, max: 75 },
    { test: "Progesterone", unit: "ng/mL", min: 0.2, max: 1.4 },
    { test: "Cortisol (Morning)", unit: "µg/dL", min: 5, max: 25 }
  ],
  "PCR / Molecular": [
    { test: "Hepatitis B DNA (PCR)", unit: "", min: 0, max: 0 },
    { test: "Hepatitis C RNA (PCR)", unit: "", min: 0, max: 0 },
    { test: "Tuberculosis PCR", unit: "", min: 0, max: 0 },
    { test: "HPV DNA PCR", unit: "", min: 0, max: 0 },
    { test: "CMV DNA PCR", unit: "", min: 0, max: 0 }
  ],
  "Allergy Panel": [
    { test: "Dust Mite IgE", unit: "kU/L", min: 0, max: 0.35 },
    { test: "Pollen IgE", unit: "kU/L", min: 0, max: 0.35 },
    { test: "Milk Protein IgE", unit: "kU/L", min: 0, max: 0.35 },
    { test: "Peanut IgE", unit: "kU/L", min: 0, max: 0.35 },
    { test: "Egg White IgE", unit: "kU/L", min: 0, max: 0.35 }
  ],
  "Drug Screening": [
    { test: "Amphetamines", unit: "", min: 0, max: 0 },
    { test: "Barbiturates", unit: "", min: 0, max: 0 },
    { test: "Benzodiazepines", unit: "", min: 0, max: 0 },
    { test: "Cannabinoids (THC)", unit: "", min: 0, max: 0 },
    { test: "Cocaine", unit: "", min: 0, max: 0 },
    { test: "Opiates", unit: "", min: 0, max: 0 }
  ],
  "Renal Function": [
    { test: "Urea", unit: "mg/dL", min: 10, max: 50 },
    { test: "Creatinine", unit: "mg/dL", min: 0.7, max: 1.3 },
    { test: "Uric Acid", unit: "mg/dL", min: 3.4, max: 7.0 },
    { test: "Calcium", unit: "mg/dL", min: 8.5, max: 10.5 },
    { test: "Phosphorus", unit: "mg/dL", min: 2.5, max: 4.5 }
  ],
  "Electrolytes": [
    { test: "Sodium (Na+)", unit: "mmol/L", min: 135, max: 145 },
    { test: "Potassium (K+)", unit: "mmol/L", min: 3.5, max: 5.0 },
    { test: "Chloride (Cl-)", unit: "mmol/L", min: 98, max: 107 },
    { test: "Bicarbonate (HCO3-)", unit: "mmol/L", min: 22, max: 29 },
    { test: "Anion Gap", unit: "mmol/L", min: 8, max: 16 }
  ],
      "Stool Examination": [
    { test: "Color", unit: "", min: 0, max: 0 },
    { test: "Consistency", unit: "", min: 0, max: 0 },
    { test: "Mucus", unit: "", min: 0, max: 0 },
    { test: "Blood", unit: "", min: 0, max: 0 },
    { test: "Occult Blood", unit: "", min: 0, max: 0 },
    { test: "Ova / Parasite", unit: "", min: 0, max: 0 },
    { test: "Reducing Substances", unit: "", min: 0, max: 0 }
  ],
  "CSF Examination": [
    { test: "Appearance", unit: "", min: 0, max: 0 },
    { test: "Protein", unit: "mg/dL", min: 15, max: 45 },
    { test: "Glucose", unit: "mg/dL", min: 40, max: 70 },
    { test: "Cell Count", unit: "cells/µL", min: 0, max: 5 },
    { test: "Gram Stain", unit: "", min: 0, max: 0 }
  ],
  "Special Chemistry": [
    { test: "HbA1c", unit: "%", min: 4, max: 5.6 },
    { test: "Ferritin", unit: "ng/mL", min: 20, max: 300 },
    { test: "Vitamin B12", unit: "pg/mL", min: 200, max: 900 },
    { test: "Vitamin D (25-OH)", unit: "ng/mL", min: 30, max: 100 },
    { test: "Folate", unit: "ng/mL", min: 3, max: 17 },
    { test: "CRP High Sensitivity", unit: "mg/L", min: 0, max: 3 }
  ],
  "Blood Gas Analysis": [
    { test: "pH", unit: "", min: 7.35, max: 7.45 },
    { test: "pCO₂", unit: "mmHg", min: 35, max: 45 },
    { test: "pO₂", unit: "mmHg", min: 80, max: 100 },
    { test: "HCO₃⁻", unit: "mmol/L", min: 22, max: 29 },
    { test: "O₂ Saturation", unit: "%", min: 95, max: 100 }
  ],
  "Endocrine Studies": [
    { test: "Insulin (Fasting)", unit: "µIU/mL", min: 2.6, max: 24.9 },
    { test: "C-Peptide", unit: "ng/mL", min: 0.8, max: 3.1 },
    { test: "Growth Hormone", unit: "ng/mL", min: 0, max: 10 },
    { test: "ACTH", unit: "pg/mL", min: 10, max: 60 }
  ],
  "Toxicology": [
    { test: "Lead (Pb)", unit: "µg/dL", min: 0, max: 10 },
    { test: "Mercury (Hg)", unit: "µg/L", min: 0, max: 5 },
    { test: "Arsenic (As)", unit: "µg/L", min: 0, max: 50 },
    { test: "Cadmium (Cd)", unit: "µg/L", min: 0, max: 5 }
  ],
  "Immunoassay": [
    { test: "HCG (Qualitative)", unit: "", min: 0, max: 0 },
    { test: "HCG (Quantitative)", unit: "mIU/mL", min: 0, max: 5 },
    { test: "Insulin Antibody", unit: "", min: 0, max: 0 },
    { test: "Thyroid Antibody (TPO)", unit: "IU/mL", min: 0, max: 35 }
  ],
  "Vitamins & Minerals": [
    { test: "Vitamin A", unit: "µg/dL", min: 20, max: 60 },
    { test: "Vitamin E", unit: "mg/L", min: 5, max: 20 },
    { test: "Zinc", unit: "µg/dL", min: 70, max: 120 },
    { test: "Copper", unit: "µg/dL", min: 70, max: 140 },
    { test: "Magnesium", unit: "mg/dL", min: 1.6, max: 2.6 }
  ],


    "Immunology": [
      { test: "ANA (Antinuclear Antibody)", unit: "", min: 0, max: 0 },
      { test: "CRP Quantitative", unit: "mg/L", min: 0, max: 6 },
      { test: "Rheumatoid Factor", unit: "IU/mL", min: 0, max: 14 }
    ]
  };

  // ===== Populate Departments =====
  const deptSel=document.getElementById('departmentSelect');
  Object.keys(departments).forEach(d=>{
    const opt=document.createElement('option');
    opt.value=d; opt.textContent=d;
    deptSel.appendChild(opt);
  });

  // On Department change
  deptSel.addEventListener('change',()=>{
    const testSel=document.getElementById('testSelect');
    testSel.innerHTML='';
    const selected=Array.from(deptSel.selectedOptions).map(o=>o.value);
    selected.forEach(dep=>{
      departments[dep].forEach(t=>{
        const opt=document.createElement('option');
        opt.value=dep+'|'+t.test;
        opt.textContent=`${dep} - ${t.test}`;
        testSel.appendChild(opt);
      });
    });
  });

  // ===== Add Result =====
  const results=[];
  function addResult(){
    const testVal=document.getElementById('testSelect').value;
    if(!testVal){alert('Select a test');return;}
    const [dep,testName]=testVal.split('|');
    const data=departments[dep].find(t=>t.test===testName);
    const result=parseFloat(document.getElementById('resultValue').value);
    if(isNaN(result)){alert('Enter numeric result');return;}
    let indicator='Normal';
    if(result<data.min)indicator='Low';
    else if(result>data.max)indicator='High';
    results.push({department:dep,test:testName,result,unit:data.unit,range:`${data.min}-${data.max}`,indicator});
    renderTable();
    document.getElementById('resultValue').value='';
  }

  function renderTable(){
    const tb=document.getElementById('resultsTable');
    tb.innerHTML='';
    results.forEach(r=>{
      const color=(r.indicator==='Normal')?'green':'red';
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${r.department}</td><td>${r.test}</td><td>${r.result}</td>
        <td>${r.unit}</td><td>${r.range}</td><td style="color:${color};font-weight:600">${r.indicator}</td>`;
      tb.appendChild(tr);
    });
  }

  // ===== Save Report =====
  function saveReport(){
    if(results.length===0){alert('Add at least one test');return;}
    const patient_code=document.getElementById('patientCode').value.trim();
    if(!patient_code){alert('Enter patient code');return;}
    const report_id='R'+Date.now();
    const newReport={
      report_id,
      patient_name:patient_code,
      patient_code,
      department:results.map(r=>r.department).join(', '),
      results,
      date:new Date().toISOString()
    };
    const reports=JSON.parse(localStorage.getItem('reports')||'[]');
    reports.push(newReport);
    localStorage.setItem('reports',JSON.stringify(reports));
    localStorage.setItem('lastReportId',report_id);
    alert('Report saved!');
    window.location='report.html';
  }
</script>

<script src="app.js"></script>
</body>
</html>
