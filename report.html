<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Patient Report</title>
  <style>
    body { font-family: Arial, sans-serif; background:#fff; color:#000; padding:40px; position:relative; }
    body::before {
      content: "";
      background: url('logo.png') no-repeat center center;
      background-size: 300px;
      opacity: 0.08;
      position: absolute; top:0; left:0; right:0; bottom:0; z-index:0;
    }
    .header { display:flex; justify-content:space-between; align-items:center; position:relative; z-index:1; }
    .header img { height:80px; }
    #qrcode { width:120px; height:120px; }
    h2 { color:#0066cc; margin:20px 0; position:relative; z-index:1; }
    table { width:100%; border-collapse:collapse; margin-top:20px; position:relative; z-index:1; }
    th, td { border:1px solid #444; padding:8px; text-align:left; }
    th { background:#0066cc; color:#fff; }
    .btn { margin-top:20px; padding:10px 20px; background:#0066cc; color:#fff; border:none; cursor:pointer; border-radius:5px; position:relative; z-index:1; }
    .footer { margin-top:40px; font-size:12px; text-align:center; color:#555; position:relative; z-index:1; }
  </style>
</head>
<body>
  <div class="header">
    <img src="logo.png" alt="Lab Logo">
    <div id="qrcode"></div>
  </div>

  <h2>AlphaMed Clinical Laboratory Report</h2>
  <div id="reportContent"></div>

  <button class="btn" onclick="window.print()">Print / Save PDF</button>

  <div class="footer">
    <p>AlphaMed Clinical Laboratory - Quality Assurance Through Advance Technology</p>
  </div>

  <script src="tests.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
  <script>
    function getQueryParam(param) {
      let url = new URL(window.location.href);
      return url.searchParams.get(param);
    }

    let id = getQueryParam("id");
    let reports = JSON.parse(localStorage.getItem("reports")) || [];
    let patient = reports.find(p => p.id == id);

    if (!patient) {
      document.body.innerHTML = "<h2>No report found!</h2>";
    } else {
      let html = `
        <h3>Patient Information</h3>
        <p><b>MRN:</b> ${patient.mrn}</p>
        <p><b>Name:</b> ${patient.name}</p>
        <p><b>Age:</b> ${patient.age} | <b>Gender:</b> ${patient.gender}</p>
        <p><b>Departments:</b> ${patient.departments.join(", ")}</p>

        <h3>Test Results</h3>
        <table>
          <tr><th>Test</th><th>Parameter</th><th>Result</th><th>Unit</th><th>Normal Range</th><th>Date</th></tr>
      `;
      patient.tests.forEach(testName => {
        let testObj;
        departmentsArray.forEach(dept => {
          let t = dept.tests.find(x => x.name === testName);
          if (t) testObj = t;
        });

        let parameter = testObj ? testObj.parameter : "-";
        let unit = testObj ? testObj.unit : "-";
        let normalRange = testObj ? `${testObj.normalMin} - ${testObj.normalMax}` : "-";

        let result = patient.results.find(r => r.test === testName);

        html += `<tr>
          <td>${testName}</td>
          <td>${parameter}</td>
          <td>${result ? result.value : "Pending"}</td>
          <td>${unit}</td>
          <td>${normalRange}</td>
          <td>${result ? result.date : "-"}</td>
        </tr>`;
      });
      html += "</table>";
      document.getElementById("reportContent").innerHTML = html;

      new QRCode(document.getElementById("qrcode"), {
        text: `MRN: ${patient.mrn} | Name: ${patient.name} | Dept: ${patient.departments.join(", ")} | Tests: ${patient.tests.join(", ")}`,
        width: 120,
        height: 120
      });
    }
  </script>
</body>
</html>
