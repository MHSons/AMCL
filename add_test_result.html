<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Add Test Results - AlphaMed Clinical Laboratory</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

  <!-- Header -->
  <div class="header">
    <h1>AlphaMed Clinical Laboratory</h1>
    <p>Technician - Add Test Results</p>
  </div>

  <!-- Search Patient -->
  <div class="container">
    <h2>Find Patient</h2>
    <input type="text" id="searchId" placeholder="Enter Patient ID (e.g., P-...)" />
    <button onclick="findPatient()">Search</button>
  </div>

  <!-- Result Entry Form -->
  <div class="container" id="result-form" style="display:none;">
    <h2>Enter Test Results</h2>
    <p><b>Patient:</b> <span id="patient-name"></span></p>
    <div id="tests-list"></div>
    <button onclick="saveResults()" style="margin-top:15px;">ðŸ’¾ Save Results</button>
  </div>

  <script>
    let currentPatient = null;

    function findPatient(){
      const id = document.getElementById("searchId").value.trim();
      const patients = JSON.parse(localStorage.getItem("patients") || "[]");
      currentPatient = patients.find(x => x.id === id);

      if(currentPatient){
        document.getElementById("result-form").style.display = "block";
        document.getElementById("patient-name").innerText = `${currentPatient.name} (${currentPatient.id})`;

        // Build test input fields
        document.getElementById("tests-list").innerHTML = currentPatient.tests.map(t => `
          <div class="test-item">
            <label>${t}</label>
            <input type="text" id="res_${t}" placeholder="Result value" />
            <input type="text" id="unit_${t}" placeholder="Unit (e.g., mg/dL)" />
            <input type="text" id="range_${t}" placeholder="Reference Range" />
          </div>
        `).join("");
      } else {
        alert("Patient not found!");
      }
    }

    function saveResults(){
      if(!currentPatient) return;

      let results = [];
      currentPatient.tests.forEach(t => {
        const value = document.getElementById("res_"+t).value;
        const unit = document.getElementById("unit_"+t).value;
        const range = document.getElementById("range_"+t).value;
        if(value){
          results.push({name:t, value, unit, range});
        }
      });

      currentPatient.results = results;

      // Update localStorage
      let patients = JSON.parse(localStorage.getItem("patients") || "[]");
      let index = patients.findIndex(x => x.id === currentPatient.id);
      if(index > -1){
        patients[index] = currentPatient;
        localStorage.setItem("patients", JSON.stringify(patients));
        alert("Results saved successfully!");
      }
    }
  </script>

</body>
</html>
