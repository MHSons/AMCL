<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Add Test Result</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header class="header smallbar">
    <div class="brand"><img src="logo.svg" class="logo"><h1 class="small">Add Test Result</h1></div>
    <nav class="nav"><a href="index.html">Home</a> <a href="register_patient.html">Register</a> <a href="view_reports.html">Reports</a></nav>
  </header>

  <main class="container">
    <h2>Find patient</h2>
    <div class="form-row">
      <input id="searchId" placeholder="Enter Patient ID (e.g., P1623456789)">
      <button id="btnSearch" class="btn">Search</button>
    </div>

    <div id="patientArea" style="margin-top:18px"></div>
  </main>

  <script src="tests.js"></script>
  <script>
    function findPatient(id) {
      const patients = JSON.parse(localStorage.getItem('patients')||'[]');
      return patients.find(p=>p.id === id);
    }

    document.getElementById('btnSearch').addEventListener('click', ()=>{
      const id = document.getElementById('searchId').value.trim();
      const area = document.getElementById('patientArea');
      area.innerHTML = '';
      if (!id) { alert('Enter patient ID'); return; }
      const p = findPatient(id);
      if (!p) { area.innerHTML = '<div class="small">Patient not found.</div>'; return; }
      // render form for adding results for selected tests
      const dept = departments.find(d => d.id === p.department);
      const html = [];
      html.push(`<h3>${p.name} (${p.id})</h3>`);
      html.push(`<div class="small">Department: ${dept ? dept.name : p.department}</div>`);
      html.push('<form id="resultsForm">');
      if (!p.tests || !p.tests.length) {
        html.push('<div class="small">No tests selected for this patient.</div>');
      } else {
        p.tests.forEach(tid => {
          // find test metadata
          let testMeta = null;
          const deptFound = departments.find(d => d.tests.some(t=>t.id===tid));
          if (deptFound) testMeta = deptFound.tests.find(tt => tt.id === tid);
          html.push(`<label>${testMeta ? testMeta.name : tid} <span class="small">(${testMeta ? testMeta.unit : ''})</span></label>`);
          html.push(`<input name="${tid}" placeholder="Enter result" required>`);
        });
      }
      html.push('<div style="margin-top:12px"><button class="btn" type="submit">Save Results</button></div>');
      html.push('</form>');
      area.innerHTML = html.join('');

      document.getElementById('resultsForm')?.addEventListener('submit', function(e){
        e.preventDefault();
        const form = new FormData(this);
        const results = {};
        for (const [k,v] of form.entries()) { results[k] = v; }
        // save results to localStorage under results array
        const allResults = JSON.parse(localStorage.getItem('results')||'[]');
        allResults.push({ patientId: p.id, results, created: new Date().toISOString(), enteredBy: (JSON.parse(localStorage.getItem('lab_user')||'null')||{}).username || 'unknown' });
        localStorage.setItem('results', JSON.stringify(allResults));
        alert('Results saved.');
      });
    });
  </script>
</body>
</html>
