<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Add Test Results</title>
  <style>
    body { background:#121212; color:#e0e0e0; font-family:Arial; padding:20px; }
    h2 { color:#00bcd4; }
    .patient-card {
      background:#1e1e1e; padding:15px; border-radius:8px; margin-bottom:20px;
      box-shadow:0 0 8px rgba(0,0,0,0.4);
    }
    .patient-card h3 { margin:0 0 10px; color:#00e5ff; }
    table { width:100%; border-collapse:collapse; margin-top:10px; }
    th, td { border:1px solid #444; padding:8px; text-align:left; font-size:14px; }
    th { background:#00bcd4; color:#fff; }
    input { width:100%; padding:5px; border-radius:5px; border:none; background:#2c2c2c; color:#fff; }
    button {
      margin-top:10px; padding:8px 15px; background:#00bcd4; border:none; border-radius:6px;
      cursor:pointer; color:#fff; font-weight:bold;
    }
    button:hover { background:#0097a7; }
  </style>
</head>
<body>
  <h2>Add Test Results</h2>
  <div id="patientList"></div>

  <script src="tests.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      let patients = JSON.parse(localStorage.getItem("patients")) || [];
      const container = document.getElementById("patientList");

      if (!patients || patients.length === 0) {
        container.innerHTML = "<p style='color:red;'>No active patients found!</p>";
        return;
      }

      patients.forEach(p => {
        let html = `<div class="patient-card">
          <h3>${p.name} (${p.age} yrs, ${p.gender})</h3>
          <p><b>MRN:</b> ${p.mrn}</p>
          <p><b>Departments:</b> ${(p.departments || []).join(", ")}</p>
          <table>
            <tr><th>Test</th><th>Parameter</th><th>Normal Range</th><th>Unit</th><th>Result</th></tr>
        `;

        (p.tests || []).forEach(testName => {
          let testObj;
          departmentsArray.forEach(dept => {
            let t = dept.tests.find(x => x.name === testName);
            if (t) testObj = t;
          });

          let normalRange = testObj ? `${testObj.normalMin} - ${testObj.normalMax}` : "-";
          let parameter = testObj ? testObj.parameter : "-";
          let unit = testObj ? testObj.unit : "-";

          html += `<tr>
            <td>${testName}</td>
            <td>${parameter}</td>
            <td>${normalRange}</td>
            <td>${unit}</td>
            <td><input type="text" id="result-${p.id}-${testName}" placeholder="Enter result"></td>
          </tr>`;
        });

        html += `</table>
          <button onclick="saveResults(${p.id})">Save Results</button>
        </div>`;

        container.innerHTML += html;
      });
    });

    function saveResults(patientId) {
      let patients = JSON.parse(localStorage.getItem("patients")) || [];
      let reports = JSON.parse(localStorage.getItem("reports")) || [];
      let patient = patients.find(p => p.id === patientId);
      if (!patient) return alert("Patient not found!");

      patient.results = [];
      (patient.tests || []).forEach(testName => {
        let val = document.getElementById(`result-${patient.id}-${testName}`).value.trim();
        if (val) {
          patient.results.push({
            test: testName,
            value: val,
            date: new Date().toLocaleString()
          });
        }
      });

      if (patient.results.length === 0) {
        return alert("Please enter at least one result.");
      }

      reports.push(patient);
      patients = patients.filter(p => p.id !== patientId);

      localStorage.setItem("patients", JSON.stringify(patients));
      localStorage.setItem("reports", JSON.stringify(reports));

      alert("Results saved and patient moved to reports!");
      location.reload();
    }
  </script>
</body>
</html>
