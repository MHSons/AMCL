<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Add Test Result - AlphaMed Clinical Laboratory</title>
  <link rel="stylesheet" href="style.css">
</head>
<body onload="loadPatient()">

  <!-- Header -->
  <div class="header">
    <h1>AlphaMed Clinical Laboratory</h1>
    <p>Add Test Result</p>
  </div>

  <div class="container">
    <h2>Patient Info</h2>
    <p><b>ID:</b> <span id="pid"></span></p>
    <p><b>Name:</b> <span id="pname"></span></p>
    <p><b>Department:</b> <span id="dept"></span></p>
  </div>

  <!-- Add Test Form -->
  <div class="container">
    <h2>Enter Test Result</h2>
    <form onsubmit="return saveResult(event)">
      <label for="testName">Test Name</label>
      <input type="text" id="testName" required>

      <label for="parameter">Parameter</label>
      <input type="text" id="parameter" required>

      <label for="result">Result</label>
      <input type="text" id="result" required>

      <label for="normal">Normal Range</label>
      <input type="text" id="normal" required>

      <button type="submit" style="margin-top:12px;">ðŸ’¾ Save Result</button>
    </form>
  </div>

  <!-- Results Table -->
  <div class="container">
    <h2>Saved Results</h2>
    <table border="1" width="100%" cellpadding="6" cellspacing="0" style="border-collapse:collapse; background:#2c2c2c; color:#eee;">
      <thead>
        <tr>
          <th>Test</th>
          <th>Parameter</th>
          <th>Result</th>
          <th>Normal Range</th>
        </tr>
      </thead>
      <tbody id="results-list"></tbody>
    </table>
    <button onclick="finishReport()" style="margin-top:12px;">âœ… Finalize Report</button>
  </div>

  <script>
    let patientIndex;
    let patients;

    function loadPatient(){
      patients = JSON.parse(localStorage.getItem("patients") || "[]");
      patientIndex = localStorage.getItem("currentPatientIndex");

      if(patientIndex === null){ 
        document.body.innerHTML = "<h2 style='color:red;'>No patient selected!</h2>";
        return;
      }

      let p = patients[patientIndex];
      document.getElementById("pid").innerText = p.id;
      document.getElementById("pname").innerText = p.name;
      document.getElementById("dept").innerText = p.department;

      if(!p.results) p.results = [];
      showResults(p.results);
    }

    function saveResult(e){
      e.preventDefault();
      let p = patients[patientIndex];
      if(!p.results) p.results = [];

      let testName = document.getElementById("testName").value.trim();
      let parameter = document.getElementById("parameter").value.trim();
      let result = document.getElementById("result").value.trim();
      let normal = document.getElementById("normal").value.trim();

      p.results.push({testName, parameter, result, normal});
      localStorage.setItem("patients", JSON.stringify(patients));

      showResults(p.results);
      e.target.reset();
    }

    function showResults(results){
      document.getElementById("results-list").innerHTML = results.map(r => `
        <tr>
          <td>${r.testName}</td>
          <td>${r.parameter}</td>
          <td>${r.result}</td>
          <td>${r.normal}</td>
        </tr>
      `).join("");
    }

    function finishReport(){
      alert("Report finalized!");
      window.location.href = "view_reports.html";
    }
  </script>

</body>
</html>
