<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Add Test Results - Alpha Med Lab</title>
  <link rel="stylesheet" href="style.css">
  <style>
    body { font-family: Arial, sans-serif; margin: 30px; }
    .patient-select { margin-bottom: 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background: #f5f5f5; }
    input[type="text"], input[type="number"] { width: 100%; padding: 6px; }
    button { margin-top: 20px; padding: 10px 20px; font-size: 1em; }
  </style>
</head>
<body>
  <h1>Add Test Results</h1>

  <div class="patient-select">
    <label for="patientSelect">Select Patient (Sample No): </label>
    <select id="patientSelect">
      <option value="">-- Choose Patient --</option>
    </select>
  </div>

  <div id="patientDetails"></div>

  <form id="resultsForm" style="display:none;">
    <table>
      <thead>
        <tr>
          <th>Test Name</th>
          <th>Parameter</th>
          <th>Normal Range</th>
          <th>Result</th>
        </tr>
      </thead>
      <tbody id="testsTable"></tbody>
    </table>
    <button type="submit">Save Results</button>
  </form>

  <script>
    const patients = JSON.parse(localStorage.getItem('patients_data') || '[]');
    const select = document.getElementById('patientSelect');
    const detailsDiv = document.getElementById('patientDetails');
    const tableBody = document.getElementById('testsTable');
    const form = document.getElementById('resultsForm');

    // Populate patient dropdown
    patients.forEach(p => {
      const opt = document.createElement('option');
      opt.value = p.sampleNo;
      opt.textContent = `${p.sampleNo} - ${p.name}`;
      select.appendChild(opt);
    });

    select.addEventListener('change', () => {
      const sampleNo = select.value;
      if (!sampleNo) {
        detailsDiv.innerHTML = '';
        form.style.display = 'none';
        return;
      }
      const patient = patients.find(p => p.sampleNo === sampleNo);
      if (!patient) return;

      detailsDiv.innerHTML = `
        <h3>Patient Info</h3>
        <p><strong>Name:</strong> ${patient.name}</p>
        <p><strong>Age/Gender:</strong> ${patient.age} / ${patient.gender}</p>
        <p><strong>Department:</strong> ${patient.department}</p>
      `;

      // Build test table
      tableBody.innerHTML = '';
      patient.tests.forEach((t, index) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${t.name}</td>
          <td>${t.parameter}</td>
          <td>${t.normalMin} - ${t.normalMax} ${t.unit}</td>
          <td>
            <input type="text" name="result-${index}" data-testid="${t.id}" required>
          </td>
        `;
        tableBody.appendChild(tr);
      });

      form.style.display = 'block';
    });

    // Save results
    form.addEventListener('submit', (e) => {
      e.preventDefault();
      const sampleNo = select.value;
      const patientIndex = patients.findIndex(p => p.sampleNo === sampleNo);
      if (patientIndex === -1) return;

      const patient = patients[patientIndex];

      // Map entered results back into tests
      const inputs = tableBody.querySelectorAll('input');
      inputs.forEach((inp, idx) => {
        const testId = inp.dataset.testid;
        const test = patient.tests.find(t => t.id === testId);
        if (test) {
          test.result = inp.value;
        }
      });

      // Update patient record
      patients[patientIndex] = patient;
      localStorage.setItem('patients_data', JSON.stringify(patients));

      alert("âœ… Results saved successfully!");
      form.reset();
      select.value = "";
      form.style.display = "none";
      detailsDiv.innerHTML = "";
    });
  </script>
</body>
</html>
