<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Departments & Tests | AlphaMed Clinical Laboratory</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg, #1e3a8a, #2563eb);
      margin: 0;
      color: #111;
      min-height: 100vh;
    }
    .container {
      max-width: 1100px;
      margin: 40px auto;
      background: white;
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.2);
    }
    h2 {
      text-align: center;
      color: #1e3a8a;
      margin-bottom: 25px;
    }
    input, select {
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 14px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    th, td {
      border-bottom: 1px solid #eee;
      padding: 8px;
      text-align: left;
      font-size: 14px;
    }
    th {
      background: #f3f4f6;
      color: #1e3a8a;
    }
    button {
      background: #2563eb;
      color: white;
      border: none;
      padding: 6px 10px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
    }
    button:hover { background: #1e3a8a; }
    .btn-del { background: #ef4444; }
    .btn-del:hover { background: #b91c1c; }
    .section {
      border: 1px solid #ddd;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 25px;
    }
    .flex { display: flex; gap: 8px; flex-wrap: wrap; }
    .back {
      display: block;
      text-align: center;
      margin-top: 15px;
      color: #2563eb;
      text-decoration: none;
    }
  </style>
</head>
<body>

  <div class="container">
    <h2>Departments & Tests Management</h2>

    <div class="section">
      <h3>Add Department</h3>
      <div class="flex">
        <input type="text" id="deptName" placeholder="Department Name" style="flex:1">
        <button onclick="addDepartment()">Add Department</button>
      </div>
    </div>

    <div class="section">
      <h3>Add Test</h3>
      <div class="flex">
        <select id="deptSelect" style="flex:1"></select>
        <input type="text" id="testName" placeholder="Test Name" style="flex:1">
        <input type="text" id="unit" placeholder="Unit (e.g., g/dL)" style="width:120px">
        <input type="number" id="minValue" placeholder="Min" style="width:80px">
        <input type="number" id="maxValue" placeholder="Max" style="width:80px">
        <input type="text" id="normalRange" placeholder="Normal Range" style="flex:1">
        <button onclick="addTest()">Add Test</button>
      </div>
    </div>

    <div class="section">
      <h3>Departments List</h3>
      <table>
        <thead>
          <tr><th>Department</th><th>Tests</th><th>Actions</th></tr>
        </thead>
        <tbody id="deptTable"></tbody>
      </table>
    </div>

    <a href="dashboard.html" class="back">← Back to Dashboard</a>
  </div>

  <script>
    const user = JSON.parse(localStorage.getItem('loggedUser') || 'null');
    if(!user){ alert('Please login first!'); window.location.href='index.html'; }
    if(user.role !== 'admin'){ alert('Only Admin can access this page'); window.location.href='dashboard.html'; }

    function loadDepartments(){
      const depts = JSON.parse(localStorage.getItem('departments') || '[]');
      const sel = document.getElementById('deptSelect');
      sel.innerHTML = '<option value="">Select Department</option>';
      depts.forEach(d => sel.innerHTML += `<option>${d.name}</option>`);

      const tbody = document.getElementById('deptTable');
      tbody.innerHTML = '';
      depts.forEach((d, i)=>{
        const tests = JSON.parse(localStorage.getItem('tests') || '[]').filter(t=>t.department===d.name);
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${d.name}</td>
          <td>${tests.length} tests</td>
          <td>
            <button onclick="viewTests('${d.name}')">View</button>
            <button class="btn-del" onclick="deleteDepartment(${i})">Delete</button>
          </td>`;
        tbody.appendChild(tr);
      });
    }

    function addDepartment(){
      const name = document.getElementById('deptName').value.trim();
      if(!name){ alert('Enter department name'); return; }
      let depts = JSON.parse(localStorage.getItem('departments') || '[]');
      if(depts.some(d=>d.name.toLowerCase()===name.toLowerCase())){
        alert('Department already exists'); return;
      }
      depts.push({ name });
      localStorage.setItem('departments', JSON.stringify(depts));
      document.getElementById('deptName').value='';
      loadDepartments();
    }

    function deleteDepartment(i){
      if(!confirm('Delete this department?')) return;
      let depts = JSON.parse(localStorage.getItem('departments') || '[]');
      const deptName = depts[i].name;
      depts.splice(i,1);
      localStorage.setItem('departments', JSON.stringify(depts));
      let tests = JSON.parse(localStorage.getItem('tests') || '[]');
      tests = tests.filter(t=>t.department!==deptName);
      localStorage.setItem('tests', JSON.stringify(tests));
      loadDepartments();
    }

    function addTest(){
      const dept = document.getElementById('deptSelect').value;
      if(!dept){ alert('Select department'); return; }
      const testName = document.getElementById('testName').value.trim();
      const unit = document.getElementById('unit').value.trim();
      const minValue = parseFloat(document.getElementById('minValue').value);
      const maxValue = parseFloat(document.getElementById('maxValue').value);
      const normalRange = document.getElementById('normalRange').value.trim();
      if(!testName || isNaN(minValue) || isNaN(maxValue)){ alert('Enter all test fields'); return; }

      const tests = JSON.parse(localStorage.getItem('tests') || '[]');
      tests.push({ department:dept, test_name:testName, unit, min_value:minValue, max_value:maxValue, normal_range_adult:normalRange });
      localStorage.setItem('tests', JSON.stringify(tests));

      alert('Test added successfully!');
      document.getElementById('testName').value='';
      document.getElementById('unit').value='';
      document.getElementById('minValue').value='';
      document.getElementById('maxValue').value='';
      document.getElementById('normalRange').value='';
      loadDepartments();
    }

    function viewTests(dept){
      const tests = JSON.parse(localStorage.getItem('tests') || '[]').filter(t=>t.department===dept);
      if(tests.length===0){ alert('No tests for this department yet.'); return; }
      let msg = `Tests in ${dept}:\n----------------------------------\n`;
      tests.forEach(t=>{
        msg += `${t.test_name} (${t.unit}) → ${t.normal_range_adult}\n`;
      });
      alert(msg);
    }

    loadDepartments();
  </script>

</body>
</html>
